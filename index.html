// --- 1. Global Variables ---
let localStream;
let peerConnection;
const log = document.getElementById('log');

// --- 2. Configuration (Essential for WebRTC) ---
// You MUST use a STUN server to help peers find each other's public IP address.
const configuration = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
    ]
};

// Function to print messages to the log box
function writeLog(message) {
    const p = document.createElement('p');
    p.textContent = message;
    log.appendChild(p);
    log.scrollTop = log.scrollHeight; // Scroll to bottom
}

// --- 3. Start the process: Get Microphone Audio ---
async function startCall() {
    writeLog('Requesting microphone access...');
    try {
        // Get the local audio stream (WebRTC for "always-on" voice is enabled by default)
        localStream = await navigator.mediaDevices.getUserMedia({ 
            audio: true, 
            video: false 
        });

        document.getElementById('localAudio').srcObject = localStream;
        writeLog('âœ… Microphone stream successfully acquired.');
        
        // --- Next Step: Establish Peer Connection ---
        // In a real app, this is where you'd connect to your signaling server.
        // For this example, we will just create the PC object.
        createPeerConnection(); 

    } catch (error) {
        writeLog(`âŒ Error accessing microphone: ${error.name}`);
        console.error('Error accessing media devices.', error);
    }
}

// --- 4. Create the Peer Connection Object ---
function createPeerConnection() {
    writeLog('Creating RTCPeerConnection...');
    peerConnection = new RTCPeerConnection(configuration);

    // Add local tracks (audio) to the connection
    localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
    });

    // Handle the remote stream being received
    peerConnection.ontrack = (event) => {
        writeLog('ðŸ”Š Remote stream track received!');
        // Attach the remote audio stream to the friend's <audio> element
        document.getElementById('remoteAudio').srcObject = event.streams[0];
    };
    
    // --- Connection Events (The Signaling Steps) ---

    // 1. Gathering ICE Candidates (Network information)
    peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
            // This event sends network info (candidate) to the other user via the server
            // writeLog(`ICE Candidate: ${event.candidate.type}`);
            // *** In a real app, you would send this to the server: ***
            // signalingServer.send({ 'ice': event.candidate });
        }
    };
    
    // 2. State changes
    peerConnection.oniceconnectionstatechange = (event) => {
        writeLog(`Connection State: ${peerConnection.iceConnectionState}`);
    };

    // *** In a real app, you would now create an Offer/Answer and exchange it via the server ***
    writeLog('RTCPeerConnection ready. Waiting for friend to join (Signaling required!)...');
    
    // Example: Initiator creates an Offer (for demonstration, not functional without server)
    // peerConnection.createOffer().then(offer => {
    //     return peerConnection.setLocalDescription(offer);
    // }).then(() => {
    //     // Send peerConnection.localDescription to the other peer via the server
    // });
}
